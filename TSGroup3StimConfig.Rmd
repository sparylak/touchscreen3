---
title: "TSGroup3StimulusConfiguration"
author: "SLP"
date: "Tuesday, November 04, 2014"
output: html_document
---

This script takes as its input reduced OR raw data from ABETII, exported as csv files, with one file corresponding to the performance of a single mouse during a single session.  Reduced data must contain AT LEAST "Correct_Grid_Position", "SampleImage", "Correct", and "Incorrect".  Presence of additional events in raw files is not problematic and will be skipped over if not matching any needed events.  However, if any information is present in the csv file prior to the header, this must be removed manually prior to analysis.

Files to use are pulled from a subfolder "raw" under the directory: 

`r getwd() ` 

Complete sets of mice are not required, as each session is processed individually.

Known issues:
-Plot of binned performance across 15-trial blocks includes only Sample 3 Correct 1 combo and does not separate match from NonMatch


```{r}
filestouse <-{}
for(mouse in 1:12){
 filepattern <- paste("Mouse", mouse, "raw.csv", sep = "")
filestouse <- append(filestouse, list.files(path = "../StimulusConfigData/", pattern = filepattern))
}
datestouse <- unique(as.Date(gsub("Mouse[1-12]raw.csv", "", filestouse), format = "%Y%m%d"))
dfkeep <- data.frame(date = {}, mouse = {}, schedule = {}, correctgrid = {}, samplegrid = {}, correct = {}, incorrect = {}, totaltrials = {})
totalskeep <- data.frame(date = {}, mouse = {}, schedule = {}, correctgrid = {}, samplegrid = {}, correcttotal = {}, incorrecttotal = {}, trialcount = {}, percent = {})
```

Data from the following dates will be analyzed:
```{r}
print(datestouse)
```

Read in schedule info from data summary sheet, same as used in daily reporting script.
```{r}
# Read in manually entered data for date, mouseid, and schedule
schedinfo <- read.csv(file = "../Data Summary.csv", header = TRUE, sep = ",", stringsAsFactors = FALSE)
#Reformat scheduleinfo dates
schedinfo$Date <- as.Date(schedinfo$Date, format = "%m/%d/%Y")
schedtrim <- schedinfo[schedinfo$Date %in% datestouse ,1:4]
#Mice are not integers
schedtrim$Mouse <- as.character(schedtrim$Mouse)
#Print extracted info for first day
print(head(schedtrim,12))
#Print extracted info for last day
print(tail(schedtrim,12))

#Generate list of schedules contained in data range of files
locationsched <- c("MatchLocationSingle", "NonMatchLocationSingle", "MatchLocationDouble", "NonMatchLocationDouble")
pretrainingsched <- c("Must Touch", "PunishInc")
```

### Loop through individual files and extract mouse number, session date, and events from each file

```{r}
###Keep track of whether current file marks a switch to new mouse or schedule
currentmouse <- 0
currentsched <- ""

for(fil in filestouse){
        
    ms1 <- read.csv(file = paste("../StimulusConfigData/",fil,sep=""), header = TRUE, stringsAsFactors = FALSE)
    numrows <- length(ms1$Item_Name)
    mouseid <- as.integer(gsub("^[0-9]*(Mouse)|raw.csv","",fil))
    if(mouseid != currentmouse) {
        totaltrials <- 0
        currentmouse <- mouseid
    }
    sessiondate <- as.Date(gsub("Mouse[1-12]raw.csv","", fil), format="%Y%m%d")
    sessionsched <- schedtrim[(schedtrim$Date == sessiondate) & (schedtrim$Mouse == mouseid),4]    
    if(sessionsched != currentsched) {
        totaltrials <- 0
        currentsched <- sessionsched
        }
    gridid <- 0
    imageid <- 0
    
    ###generate empty data frame with number of rows based on number of correct grid positions set in file
    dfrows <- (sum(ms1$Item_Name == "Correct_Grid_Position") - 1)
    trackerdf <- data.frame(date = rep(sessiondate,dfrows), mouse = rep(mouseid,dfrows), schedule = rep(sessionsched,dfrows), correctgrid = rep(0,dfrows), samplegrid = 0, correct = 0, incorrect = 0, totaltrials = 0, row.names = (1:dfrows))
    ### Warning: grid positions will initially be set to zero
    rowindex <- 1
    ###loop through each row of csv file and fill values in empty data frame according to event type
    for(row in 1:numrows) {
        if(ms1[row, 4] == "Correct_Grid_Position") {
            gridid <- ms1[row, 9]
            trackerdf$correctgrid[rowindex] <- gridid
        }
        else if(ms1[row, 4] == "Sample_Grid_Position") {
            imageid <-ms1[row, 9]
            trackerdf$samplegrid[rowindex] <- imageid
        }    
        else if(ms1[row, 4] == "Correct") {
            trackerdf$correct[rowindex] <- 1
            rowindex <- rowindex + 1
        }
        else if(ms1[row, 4] == "Incorrect") {
            trackerdf$incorrect[rowindex] <- trackerdf$incorrect[rowindex] + 1
        }
        else if(ms1[row, 4] == "No correction") {
            rowindex <- rowindex + 1
        }
    }
    ###Calculate running tally of trials for session, starting from point reached in last session for same mouse and schedule.
    
    for (row in 1:dfrows){
        if(row == 1){
            trackerdf$totaltrials[row] <- trackerdf$correct[row] + trackerdf$incorrect[row] + totaltrials
        } else {
            trackerdf$totaltrials[row] <- trackerdf$totaltrials[row - 1] + trackerdf$correct[row] + trackerdf$incorrect[row]
        }
    }
    ###bind data from individual file to all previous files
    dfkeep <- rbind(dfkeep, trackerdf)
    totaltrials <- trackerdf$totaltrials[dfrows]
    library(plyr)
    ###summarize correct and incorrect responses session and bind to all previous sessions
    dftotals <- ddply(trackerdf, .(date, mouse, schedule, correctgrid, samplegrid), summarize, correcttotal = sum(correct), incorrecttotal = sum(incorrect))
    dftotals$trialcount <- (dftotals$correcttotal + dftotals$incorrecttotal)
    dftotals$percent <- (dftotals$correcttotal/(dftotals$correcttotal + dftotals$incorrecttotal))
    totalskeep <- rbind(totalskeep, dftotals)
}
```

###Cut dfkeep into blocks of 50 trials, and display performance for each schedule across trial blocks
```{r fig.height = 8, fig.width = 10}
dfkeep$trialblock <- as.factor(cut(dfkeep$totaltrials, breaks = 50*(0:12), include.lowest = TRUE, labels = FALSE))
blockeddf<- ddply(dfkeep, .(mouse, schedule, trialblock), summarize, totalcorrect = sum(correct), trials = (max(totaltrials)))
blockeddf$trials <- blockeddf$trials - 50*(as.integer(blockeddf$trialblock)-1)
blockeddf$percentall <- blockeddf$totalcorrect/blockeddf$trials
blockeddf$mouse <- as.factor(blockeddf$mouse)
library(ggplot2)
g <- ggplot(blockeddf, aes(x = trialblock, y = percentall, group = mouse)) + geom_point(aes(color = mouse), size = 4) + geom_line(aes(color = mouse)) + scale_colour_brewer(type = "qual", palette = "Paired") + facet_grid(schedule ~ . ) + facet_wrap( ~ schedule, ncol = 2)
print(g)
###this is nice, but what about individual stimulus combos?

s3c1 <- dfkeep[(dfkeep$correctgrid == 1 & dfkeep$samplegrid == 3),]
s3c1 <- s3c1[grepl(pattern = "Double", x = s3c1$schedule),]
#currently this wipes out the original trial number and counts only trials of the same stimulus configuration type
stimrows <- length(s3c1$mouse)
for(row in 1:stimrows){
    ###need to somehow mark transition points between mice, schedules without excessive forloops???
    if(row == 1){
            s3c1$totaltrials[row] <- s3c1$correct[row] + s3c1$incorrect[row] 
        } else if ((s3c1$mouse[row] == s3c1$mouse[row - 1]) & (s3c1$schedule[row] == s3c1$schedule[row - 1])){
            s3c1$totaltrials[row] <- s3c1$totaltrials[row - 1] + s3c1$correct[row] + s3c1$incorrect[row]
        } else {s3c1$totaltrials[row] <- s3c1$correct[row] + s3c1$incorrect[row]}
    }
###with 6 differet stimulus configuations, number of trials at each is limited.  breaks are thus blocks of 15 trials here vs. 50 trials when all combos are lumped together
s3c1$trialblock <- as.factor(cut(s3c1$totaltrials, breaks = 15*(0:10), include.lowest = TRUE, labels = FALSE))
###graph it!
stimblocked<- ddply(s3c1, .(mouse, schedule, trialblock), summarize, totalcorrect = sum(correct), trials = (max(totaltrials)))
stimblocked$trials <- stimblocked$trials - 15*(as.integer(stimblocked$trialblock)-1)
stimblocked$percentall <- stimblocked$totalcorrect/stimblocked$trials
stimblocked$mouse <- as.factor(stimblocked$mouse)
library(ggplot2)
g <- ggplot(stimblocked, aes(x = trialblock, y = percentall, group = mouse)) + geom_point(aes(color = mouse), size = 4) + geom_line(aes(color = mouse)) + scale_colour_brewer(type = "qual", palette = "Paired") + facet_grid(schedule ~ . ) + facet_wrap( ~ schedule, ncol = 2)
print(g)


```

###Save output?

```{r}
###Save output files to output directory
write.csv(dfkeep, file = paste("../output/", Sys.Date(),"rawcombooutput.csv",sep=""), row.names = FALSE)
write.csv(totalskeep, file = paste("../output/", Sys.Date(),".combooutput.csv", sep=""), row.names = FALSE)
```

###Is the proportion of correct and incorrect trials equal across all sample and correct grid combinations?

Equality of performance across stimulus combinations will be checked via Pearson's chi-squared test. Subsequently, each stimulus configuration can be checked separately to determine if responding differs from chance performance, assumed to be 50%.


```{r}
###Perform chi-squared tests for each image/side combo
###Note that initial chi-squared across groups compares independence of distributions, whereas
###chi-squared tests of individual rows compare correct vs. incorrect responding to a hypothetical 50% chance 
combotabslong <- ddply(totalskeep, .(schedule, correctgrid, samplegrid), summarize, totaltrials = sum(trialcount), correct = sum(correcttotal), incorrect = sum(incorrecttotal), meanalldays = (correct/(correct+incorrect)))
print(combotabslong)
###Across all possible configurations, collapsing across schedules
###WARNING:  In Match schedules up to but not including DoubleEasy, "Correct_Grid_Position" actually refers to location of the foil
combotabsnonmatch <- ddply(totalskeep[grep("^NonMatchLocationDouble", totalskeep$schedule),], .(correctgrid, samplegrid), summarize, totaltrials = sum(trialcount), correct = sum(correcttotal), incorrect = sum(incorrecttotal), meanalldays = (correct/(correct+incorrect)))
print(combotabsnonmatch)
print(chisq.test(combotabsnonmatch[,4:5]))

combotabsmatch <- ddply(totalskeep[grep("^MatchLocationDouble", totalskeep$schedule),], .(correctgrid, samplegrid), summarize, totaltrials = sum(trialcount), correct = sum(correcttotal), incorrect = sum(incorrecttotal), meanalldays = (correct/(correct+incorrect)))
print(combotabsmatch)
print(chisq.test(combotabsmatch[,4:5]))

```

**A large disparity exists in responding to different configurations.**


**Note that for Match mice, the Correct_Grid_Position actually indicates, the foil, and the Incorrect_Grid_Position is the blank.  So the comma notation refers to the following: (ImageAppearingInSample,ImageAppearingInChoiceOnly)**

```{r fig.height = 8, fig.width = 10}

###Output graph of percent correct across days for all stimulus combinations split by mouse
easy <- totalskeep[grep("Easy", totalskeep$schedule),]
bymouseeasy <- ddply(easy, .(mouse, schedule, correctgrid, samplegrid), summarize, totaltrials = sum(trialcount), correct = sum(correcttotal), incorrect = sum(incorrecttotal), meanalldays = (correct/(correct+incorrect)))
bymouseeasy$trialcode <- paste(bymouseeasy$samplegrid,bymouseeasy$correctgrid, sep = ",")
bymouseeasy$trialcode <- factor(bymouseeasy$trialcode, levels = c("1,1","3,1","1,3","3,3"))
library(ggplot2)
g <- ggplot(bymouseeasy, aes(x = trialcode, y = meanalldays)) + geom_point(aes(color = schedule),size = 4) + geom_text(aes(x = trialcode, y = -0.05, label = totaltrials)) + coord_cartesian(ylim = c(-.1,1.1)) + facet_wrap(~ mouse, ncol = 2) + ggtitle("Mice on Easy Schedules have strong Left side biases")
print(g)

noteasy <- totalskeep[grep("Easy|Single", totalskeep$schedule, invert = TRUE),]
bymouse <- ddply(noteasy, .(mouse, schedule, correctgrid, samplegrid), summarize, totaltrials = sum(trialcount), correct = sum(correcttotal), incorrect = sum(incorrecttotal), meanalldays = (correct/(correct+incorrect)))
bymouse$trialcode <- paste(bymouse$samplegrid,bymouse$correctgrid, sep = ",")
bymouse$trialcode <- factor(bymouse$trialcode, levels = c("1,2","1,3","2,1","2,3","3,1","3,2"))
library(ggplot2)
g <- ggplot(bymouse[grep("^NonMatch", bymouse$schedule),], aes(x = trialcode, y = meanalldays)) + geom_point(aes(color = schedule),size = 4) + geom_text(aes(x = trialcode, y = -0.05, label = totaltrials)) + coord_cartesian(ylim = c(-.1,1.10)) + facet_wrap(~ mouse, ncol = 2) + ggtitle("Mice on NonMatch Schedules also prefer left, except #3")
print(g)

g <- ggplot(bymouse[grep("^Match", bymouse$schedule),], aes(x = trialcode, y = meanalldays)) + geom_point(aes(color = schedule),size = 4) + geom_text(aes(x = trialcode, y = -0.05, label = totaltrials)) + coord_cartesian(ylim = c(-.1,1.10)) + facet_wrap(~ mouse, ncol = 2) + ggtitle("Location preference not as clear in Match mice.  #2 prefers center, #7 prefers left, #8 dislikes center")
print(g)
```

**Across mice, the side preference appears more robust and consistent than the image preference.**

```{r fig.height = 8}
###Output histogram of incorrect responses per correct, excluding zero-incorrect sequences.
dfincorrect <- dfkeep[dfkeep$incorrect != 0,]
dfdoubleinc <- dfincorrect[grepl(pattern = "Double", dfincorrect$schedule),]
inccount <- count(dfdoubleinc, vars = .(incorrect))
g<- ggplot(inccount, aes(x = incorrect, y = freq)) + geom_point(size = 4)
print(g)
```